<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Webcam Recorder with Trimming and Merging</title>
</head>
<body style="font-family: sans-serif; text-align: center; margin-top: 20px;">
Â  Â Â 
Â  Â  <h1 style="color: #007bff;">Webcam Capture and Recorder</h1>

Â  Â  <p>My main UnoQ Index <a href="https://hpssjellis.github.io/my-examples-UnoQ-qualcomm-edgeimpulse-arduino/public/index.html"> here </a> </p>Â Â 
Â  Â  <p>My UnoQ Github is<a href="https://github.com/hpssjellis/my-examples-UnoQ-qualcomm-edgeimpulse-arduino"> my-examples-of-UnoQ... </a> </p>Â Â 
Â  Â  <p>You can find more of my work on my <a href="https://github.com/hpssjellis"> hpssjellis </a> GitHub Profile page:</p>
Â  Â  <p>Follow me Jeremy Ellis on <a href="https://ca.linkedin.com/in/jeremy-ellis-4237a9bb"> LinkedIn </a><br></p>

Â  Â  <video id="myLiveStreamVideo" autoplay playsinline style="display: none;"></video>

Â  Â  <canvas id="myVideoCanvas" width="640" height="480" style="border: 2px solid #ccc; max-width: 90%; margin-bottom: 20px;"></canvas>

    <div id="myStartSection" style="margin-bottom: 20px;">
        <button id="myStartButton" style="padding: 15px 30px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.2em;">
            â–¶ï¸ Start Webcam and Enable Controls
        </button>
    </div>
    Â  Â  <div id="myControls" style="display: none; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select id="myCameraSelect" style="padding: 10px; border: 1px solid #007bff; border-radius: 5px;">
Â  Â  Â  Â  Â  Â  <option>Select Camera</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select id="myResolutionSelect" style="padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
Â  Â  Â  Â  Â  Â  <option>Loading Resolutions...</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select id="myFormatSelect" style="padding: 10px; border: 1px solid #28a745; border-radius: 5px;" disabled>
Â  Â  Â  Â  Â  Â  <option>Loading Formats...</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="myPhotoButton" style="padding: 10px 20px; background-color: #ffc107; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  ğŸ“¸ Take Photo
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button id="myRecordButton" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  ğŸ”´ Start Recording
Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  <button id="myPauseButton" style="padding: 10px 20px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  â¸ï¸ Pause
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <a id="myDownloadLink" style="display: inline-block; padding: 10px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px;">Download Video</a>
Â  Â  </div>
Â  Â Â 
Â  Â  <div style="margin-top: 20px; margin-bottom: 20px;">
Â  Â  Â  Â  <h3 style="margin: 0 0 10px 0;">Upload Video for Clipping/Trimming</h3>
Â  Â  Â  Â  <input type="file" id="myUploadClipFile" accept="video/*" style="padding: 10px; border: 1px solid #007bff; border-radius: 5px;">
Â  Â  </div>

Â  Â  <video id="myRecordedVideo" controls style="display: none; border: 2px solid green; max-width: 90%; margin-bottom: 20px;"></video>

Â  Â  <div id="myTrimmingControls" style="display: none; max-width: 640px; margin: 0 auto 20px auto; padding: 15px; border: 2px solid #007bff; border-radius: 5px; background-color: #f0f8ff;">
Â  Â  Â  Â  <h3 style="margin-top: 0;">Trim Video</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Time: <span id="myStartTimeDisplay">0.0s</span></label>
Â  Â  Â  Â  Â  Â  <input type="range" id="myStartSlider" min="0" max="100" value="0" step="0.1" style="width: 100%;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Time: <span id="myEndTimeDisplay">0.0s</span></label>
Â  Â  Â  Â  Â  Â  <input type="range" id="myEndSlider" min="0" max="100" value="100" step="0.1" style="width: 100%;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  <strong>Duration:</strong> <span id="myDurationDisplay">0.0s</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="mySaveTrimmedButton" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">
Â  Â  Â  Â  Â  Â  ğŸ’¾ Prep for Download Trimmed Video
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="myCancelTrimButton" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
Â  Â  Â  Â  Â  Â  âŒ Cancel (Keep Full Video)
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="myMergingControls" style="max-width: 800px; margin: 0 auto 20px auto; padding: 15px; border: 2px solid #ff6b6b; border-radius: 5px; background-color: #fff5f5;">
Â  Â  Â  Â  <h3 style="margin-top: 0;">ğŸ¬ Merge Two Videos</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
Â  Â  Â  Â  Â  Â  <div style="flex: 1; min-width: 250px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Video 1 (First)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="myVideoFile1" accept="video/*" style="margin-bottom: 10px; display: block; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <video id="myPreview1" controls style="width: 100%; max-height: 200px; border: 2px solid #ddd; display: none;"></video>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="myVideo1Info" style="font-size: 12px; color: #666;"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="flex: 1; min-width: 250px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Video 2 (Second)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="myVideoFile2" accept="video/*" style="margin-bottom: 10px; display: block; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <video id="myPreview2" controls style="width: 100%; max-height: 200px; border: 2px solid #ddd; display: none;"></video>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="myVideo2Info" style="font-size: 12px; color: #666;"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="myMergeButton" style="padding: 10px 20px; background-color: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  ğŸï¸ Merge Videos
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="myMergeProgress" style="display: none; margin-top: 15px;">
Â  Â  Â  Â  Â  Â  <p><strong>Processing...</strong></p>
Â  Â  Â  Â  Â  Â  <div style="width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="myProgressBar" style="width: 0%; background-color: #4CAF50; height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <video id="myMergedVideo" controls style="display: none; width: 100%; max-width: 640px; margin-top: 15px; border: 2px solid #4CAF50;"></video>
Â  Â  Â  Â  <a id="myMergedDownloadLink" style="display: none; padding: 10px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 5px; margin-top: 10px; inline-block;">Download Merged Video</a>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- 1. Global Variables (Declarations) ---
        const myStartButton = document.getElementById('myStartButton');
        const myStartSection = document.getElementById('myStartSection');
        const myControls = document.getElementById('myControls'); 

Â  Â  Â  Â  const myLiveStreamVideo = document.getElementById('myLiveStreamVideo');
Â  Â  Â  Â  const myVideoCanvas = document.getElementById('myVideoCanvas');
Â  Â  Â  Â  const myRecordedVideo = document.getElementById('myRecordedVideo');
Â  Â  Â  Â  const myCameraSelect = document.getElementById('myCameraSelect');
Â  Â  Â  Â  const myResolutionSelect = document.getElementById('myResolutionSelect');
Â  Â  Â  Â  const myFormatSelect = document.getElementById('myFormatSelect');
Â  Â  Â  Â  const myPhotoButton = document.getElementById('myPhotoButton');
Â  Â  Â  Â  const myRecordButton = document.getElementById('myRecordButton');
Â  Â  Â  Â  const myPauseButton = document.getElementById('myPauseButton');
Â  Â  Â  Â  const myDownloadLink = document.getElementById('myDownloadLink');
Â  Â  Â  Â  const myCanvasContext = myVideoCanvas.getContext('2d');

Â  Â  Â  Â  const myUploadClipFile = document.getElementById('myUploadClipFile');Â 

Â  Â  Â  Â  // Trimming elements
Â  Â  Â  Â  const myTrimmingControls = document.getElementById('myTrimmingControls');
Â  Â  Â  Â  const myStartSlider = document.getElementById('myStartSlider');
Â  Â  Â  Â  const myEndSlider = document.getElementById('myEndSlider');
Â  Â  Â  Â  const myStartTimeDisplay = document.getElementById('myStartTimeDisplay');
Â  Â  Â  Â  const myEndTimeDisplay = document.getElementById('myEndTimeDisplay');
Â  Â  Â  Â  const myDurationDisplay = document.getElementById('myDurationDisplay');
Â  Â  Â  Â  const mySaveTrimmedButton = document.getElementById('mySaveTrimmedButton');
Â  Â  Â  Â  const myCancelTrimButton = document.getElementById('myCancelTrimButton');

Â  Â  Â  Â  // Merging elements
        const myVideoFile1 = document.getElementById('myVideoFile1');
Â  Â  Â  Â  const myVideoFile2 = document.getElementById('myVideoFile2');
Â  Â  Â  Â  const myPreview1 = document.getElementById('myPreview1');
Â  Â  Â  Â  const myPreview2 = document.getElementById('myPreview2');
Â  Â  Â  Â  const myVideo1Info = document.getElementById('myVideo1Info');
Â  Â  Â  Â  const myVideo2Info = document.getElementById('myVideo2Info');
Â  Â  Â  Â  const myMergeButton = document.getElementById('myMergeButton');
Â  Â  Â  Â  const myMergeProgress = document.getElementById('myMergeProgress');
Â  Â  Â  Â  const myProgressBar = document.getElementById('myProgressBar');
Â  Â  Â  Â  const myMergedVideo = document.getElementById('myMergedVideo');
Â  Â  Â  Â  const myMergedDownloadLink = document.getElementById('myMergedDownloadLink');


Â  Â  Â  Â  let myCurrentStream = null;
Â  Â  Â  Â  let myMediaRecorder = null;
Â  Â  Â  Â  let myRecordedChunks = [];
Â  Â  Â  Â  let myIsRecording = false;
Â  Â  Â  Â  let myRecordedVideoBlob = null; 
Â  Â  Â  Â  let myVideoDuration = 0;
Â  Â  Â  Â  let myVideo1Blob = null;
Â  Â  Â  Â  let myVideo2Blob = null;Â  
        let myAnimationFrameID = null;
        let myIsPaused = false;


Â  Â  Â  Â  // --- 2. Core Dependency Functions (Defined first to resolve ReferenceError) ---

        function myStopCurrentStream() {
Â  Â  Â  Â  Â  Â  if (myCurrentStream) {
Â  Â  Â  Â  Â  Â  Â  Â  myCurrentStream.getTracks().forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  Â  Â  myCurrentStream = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (myAnimationFrameID) {
Â  Â  Â  Â  Â  Â  Â  Â  cancelAnimationFrame(myAnimationFrameID);
Â  Â  Â  Â  Â  Â  Â  Â  myAnimationFrameID = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function myDrawLoop() {
Â  Â  Â  Â  Â  Â  // Only draw if not paused and the video stream is active
Â  Â  Â  Â  Â  Â  if (!myIsPaused && myLiveStreamVideo.srcObject) {
Â  Â  Â  Â  Â  Â  Â  Â  myCanvasContext.drawImage(myLiveStreamVideo, 0, 0, myVideoCanvas.width, myVideoCanvas.height);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  myAnimationFrameID = requestAnimationFrame(myDrawLoop);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function myChangeCamera(deviceId) {
Â  Â  Â  Â  Â  Â  myStopCurrentStream(); // Stop any existing stream
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const mySelectedResolution = myResolutionSelect.value.split('x');
Â  Â  Â  Â  Â  Â  const myConstraints = {
Â  Â  Â  Â  Â  Â  Â  Â  video: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  deviceId: deviceId ? { exact: deviceId } : undefined,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width: { exact: parseInt(mySelectedResolution[0]) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height: { exact: parseInt(mySelectedResolution[1]) }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  audio: true
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  myCurrentStream = await navigator.mediaDevices.getUserMedia(myConstraints);
Â  Â  Â  Â  Â  Â  Â  Â  myLiveStreamVideo.srcObject = myCurrentStream;
Â  Â  Â  Â  Â  Â  Â  Â  myLiveStreamVideo.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myVideoCanvas.width = myLiveStreamVideo.videoWidth;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myVideoCanvas.height = myLiveStreamVideo.videoHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myLiveStreamVideo.play();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myDrawLoop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myPhotoButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myRecordButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error accessing media devices: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Could not access the camera. Check permissions and device availability.");
Â  Â  Â  Â  Â  Â  Â  Â  myPhotoButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  myRecordButton.disabled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- 3. Setup Functions (Unchanged Logic, just placed higher) ---

Â  Â  Â  Â  function myLoadResolutionPresets() {
Â  Â  Â  Â  Â  Â  const myResolutionPresets = [
Â  Â  Â  Â  Â  Â  Â  Â  { width: 1280, height: 720, name: 'HD (720p)' },
Â  Â  Â  Â  Â  Â  Â  Â  { width: 640, height: 480, name: 'VGA (480p)' },
Â  Â  Â  Â  Â  Â  Â  Â  { width: 320, height: 240, name: 'QVGA (240p)' },
Â  Â  Â  Â  Â  Â  Â  Â  { width: 1920, height: 1080, name: 'Full HD (1080p)' }
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myResolutionSelect.innerHTML = '';
Â  Â  Â  Â  Â  Â  for (const preset of myResolutionPresets) {
Â  Â  Â  Â  Â  Â  Â  Â  const myOption = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  myOption.value = preset.width + 'x' + preset.height;
Â  Â  Â  Â  Â  Â  Â  Â  myOption.textContent = preset.name;
Â  Â  Â  Â  Â  Â  Â  Â  myResolutionSelect.appendChild(myOption);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  myResolutionSelect.value = '640x480';Â Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function myLoadSupportedFormats() {
Â  Â  Â  Â  Â  Â  const myFormatsToCheck = [
Â  Â  Â  Â  Â  Â  Â  Â  { mime: 'video/webm; codecs=vp9,opus', name: 'WebM (High Quality)' },
Â  Â  Â  Â  Â  Â  Â  Â  { mime: 'video/webm; codecs=vp8,opus', name: 'WebM (Standard)' },
Â  Â  Â  Â  Â  Â  Â  Â  { mime: 'video/webm', name: 'WebM (Default)' }
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  myFormatSelect.innerHTML = '';
Â  Â  Â  Â  Â  Â  let mySupportedCount = 0;

Â  Â  Â  Â  Â  Â  for (const format of myFormatsToCheck) {
Â  Â  Â  Â  Â  Â  Â  Â  if (MediaRecorder.isTypeSupported(format.mime)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const myOption = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myOption.value = format.mime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myOption.textContent = format.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myFormatSelect.appendChild(myOption);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mySupportedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (mySupportedCount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  myFormatSelect.disabled = false;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  myFormatSelect.innerHTML = '<option>No Recording Formats Supported</option>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // --- 4. NEW Startup Function tied to the button ---


async function myRequestMediaPermissionAndSetupCameras() {
    // ... (Your existing button disabling code)
    myStartButton.disabled = true;
    myStartButton.textContent = 'â³ Requesting Permission...';

    // The most basic, flexible constraint
    const constraints = {
        video: true,
        audio: true 
    };

    try {
        // Attempt to get the stream
        const myTempStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Success (No Permission Denied)
        myTempStream.getTracks().forEach(track => track.stop()); 
        console.log("SUCCESS: Permission granted and stream obtained.");

        // Now proceed to enumerate and set up as before
        await mySetupCamerasAfterPermission(); // A new function we'll define below

    } catch (error) {
        // FAILURE: Log the exact error details
        console.error("CRITICAL GETUSERMEDIA ERROR DETAILS:", error);
        console.error(`Error Name: ${error.name}, Message: ${error.message}`);
        
        if (error.name === 'NotAllowedError') {
            alert("Permission was denied by the user or system. Check browser settings.");
            myStartButton.textContent = 'ğŸ›‘ Permission Denied. Check your settings!';
        } else if (error.name === 'NotFoundError') {
            alert("No camera/microphone found on this device.");
            myStartButton.textContent = 'âŒ No Camera Found.';
        } else if (error.name === 'NotReadableError') {
            alert("Camera is in use by another app or driver is unavailable.");
            myStartButton.textContent = 'âš ï¸ Camera in Use.';
        } else {
            alert(`Unknown Media Error: ${error.name}. See console for details.`);
            myStartButton.textContent = 'âŒ Media Error.';
        }
        myStartButton.style.backgroundColor = '#dc3545';
        myStartButton.disabled = false;
    }
}

// You need to wrap the rest of your setup logic into a new function
async function mySetupCamerasAfterPermission() {
    // This is where you put the logic that runs AFTER permission is confirmed,
    // including enumerateDevices() and starting the stream.
    try {
        const myDevices = await navigator.mediaDevices.enumerateDevices();
        // ... (The rest of your code for filling the select box and calling myChangeCamera)
        // This is what was previously inside the try block of your old function.

        // Example start of previous setup logic:
        const myCameraSelect = document.getElementById('myCameraSelect');
        myCameraSelect.innerHTML = '';
        let defaultDeviceId = null;
        let myCameraCount = 0;

        for (const myDevice of myDevices) {
            if (myDevice.kind === 'videoinput') {
                const myOption = document.createElement('option');
                myOption.value = myDevice.deviceId;
                myOption.textContent = myDevice.label || 'Camera ' + (++myCameraCount); 
                myCameraSelect.appendChild(myOption);
                if (!defaultDeviceId) defaultDeviceId = myDevice.deviceId;
                myCameraCount++;
            }
        }
        
        if (defaultDeviceId) {
            myChangeCamera(defaultDeviceId);
            document.getElementById('myStartSection').style.display = 'none';
            document.getElementById('myControls').style.display = 'flex';
        } else {
            // Handle no cameras found
            myStartButton.textContent = 'âŒ No Cameras Found (Post Enum)';
            document.getElementById('myStartButton').style.backgroundColor = '#dc3545';
        }

    } catch (error) {
        console.error("ENUMERATE DEVICES FAILED:", error);
        alert("Camera enumeration failed. Device list is likely inaccessible.");
    }
}
        

        // --- 5. Recording, Trimming, and Merging Functions (Unchanged from original logic) ---

Â  Â  Â  Â  function mySetDownloadLink(blob, prefix) {
Â  Â  Â  Â  Â  Â  const myURL = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  myDownloadLink.href = myURL;
Â  Â  Â  Â  Â  Â  myDownloadLink.download = prefix + Date.now() + '.webm';
Â  Â  Â  Â  Â  Â  myDownloadLink.textContent = 'Download Saved Video';
Â  Â  Â  Â  Â  Â  myDownloadLink.style.backgroundColor = '#28a745';
Â  Â  Â  Â  }

Â  Â  Â  Â  function mySetRecordedVideoForTrimming(blob) {
Â  Â  Â  Â  Â  Â  myRecordedVideoBlob = blob;
Â  Â  Â  Â  Â  Â  myRecordedVideo.src = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  myRecordedVideo.style.display = 'block';
Â  Â  Â  Â  Â  Â  myRecordedVideo.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  myVideoDuration = myRecordedVideo.duration;
Â  Â  Â  Â  Â  Â  Â  Â  mySetupTrimmingControls();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  myUploadClipFile.onchange = function(e) {
Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  if (file && file.type.startsWith('video/')) {
Â  Â  Â  Â  Â  Â  Â  Â  mySetDownloadLink(file, 'uploaded_');
Â  Â  Â  Â  Â  Â  Â  Â  mySetRecordedVideoForTrimming(file);
Â  Â  Â  Â  Â  Â  Â  Â  myTrimmingControls.style.display = 'block';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Please select a valid video file.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  function mySetupTrimmingControls() {
Â  Â  Â  Â  Â  Â  // Set max value of sliders to video duration
Â  Â  Â  Â  Â  Â  myStartSlider.max = myVideoDuration;
Â  Â  Â  Â  Â  Â  myEndSlider.max = myVideoDuration;

Â  Â  Â  Â  Â  Â  // Reset sliders to start/end of video
Â  Â  Â  Â  Â  Â  myStartSlider.value = 0;
Â  Â  Â  Â  Â  Â  myEndSlider.value = myVideoDuration;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myUpdateTrimmingDisplay();
Â  Â  Â  Â  }

Â  Â  Â  Â  function myUpdateTrimmingDisplay() {
Â  Â  Â  Â  Â  Â  const startTime = parseFloat(myStartSlider.value);
Â  Â  Â  Â  Â  Â  const endTime = parseFloat(myEndSlider.value);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ensure start time is before end time
Â  Â  Â  Â  Â  Â  if (startTime > endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  myEndSlider.value = startTime;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const finalEndTime = parseFloat(myEndSlider.value);
Â  Â  Â  Â  Â  Â  const duration = finalEndTime - startTime;

Â  Â  Â  Â  Â  Â  myStartTimeDisplay.textContent = startTime.toFixed(1) + 's';
Â  Â  Â  Â  Â  Â  myEndTimeDisplay.textContent = finalEndTime.toFixed(1) + 's';
Â  Â  Â  Â  Â  Â  myDurationDisplay.textContent = duration.toFixed(1) + 's';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update video player to current start time for preview
Â  Â  Â  Â  Â  Â  myRecordedVideo.currentTime = startTime;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Add event listeners for the sliders
Â  Â  Â  Â  myStartSlider.addEventListener('input', myUpdateTrimmingDisplay);
Â  Â  Â  Â  myEndSlider.addEventListener('input', myUpdateTrimmingDisplay);

Â  Â  Â  Â  mySaveTrimmedButton.onclick = async function() {
Â  Â  Â  Â  Â  Â  mySaveTrimmedButton.disabled = true;
Â  Â  Â  Â  Â  Â  const startTime = parseFloat(myStartSlider.value);
Â  Â  Â  Â  Â  Â  const endTime = parseFloat(myEndSlider.value);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (endTime <= startTime || !myRecordedVideoBlob) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Invalid trim selection.");
Â  Â  Â  Â  Â  Â  Â  Â  mySaveTrimmedButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myDownloadLink.textContent = 'Processing Trim...';
Â  Â  Â  Â  Â  Â  myDownloadLink.style.backgroundColor = '#ffc107';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const trimmedBlob = await myTrimVideoWithAudio(myRecordedVideoBlob, startTime, endTime);
Â  Â  Â  Â  Â  Â  Â  Â  mySetDownloadLink(trimmedBlob, 'trimmed_video_');
Â  Â  Â  Â  Â  Â  Â  Â  mySetRecordedVideoForTrimming(trimmedBlob); // Load trimmed video into the player
Â  Â  Â  Â  Â  Â  Â  Â  myTrimmingControls.style.display = 'none';
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Trimming failed:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Video trimming failed. See console for details.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  mySaveTrimmedButton.disabled = false;
Â  Â  Â  Â  };

Â  Â  Â  Â  async function myTrimVideoWithAudio(videoBlob, startTime, endTime) {
Â  Â  Â  Â  Â  Â  return new Promise(function(resolve, reject) {
Â  Â  Â  Â  Â  Â  Â  Â  const video = document.createElement('video');
Â  Â  Â  Â  Â  Â  Â  Â  video.src = URL.createObjectURL(videoBlob);
Â  Â  Â  Â  Â  Â  Â  Â  video.muted = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  video.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = video.videoWidth;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = video.videoHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const stream = canvas.captureStream(30);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const audioContext = new AudioContext();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const source = audioContext.createMediaElementSource(video);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const destination = audioContext.createMediaStreamDestination();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  source.connect(destination);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const audioTrack = destination.stream.getAudioTracks()[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (audioTrack) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stream.addTrack(audioTrack);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const recorder = new MediaRecorder(stream, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mimeType: 'video/webm;codecs=vp8,opus',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audioBitsPerSecond: 128000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoBitsPerSecond: 2500000
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chunks = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.ondataavailable = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.data.size > 0) chunks.push(e.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.onstop = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audioContext.close();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(new Blob(chunks, { type: 'video/webm' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video.currentTime = startTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video.play();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const drawFrame = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (video.currentTime >= endTime || video.ended) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video.pause();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(drawFrame);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video.onseeked = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawFrame();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function myCancelTrimming() {
Â  Â  Â  Â  Â  Â  myTrimmingControls.style.display = 'none';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Reset the download link and video player to the full recorded/uploaded video blob
Â  Â  Â  Â  Â  Â  if (myRecordedVideoBlob) {
Â  Â  Â  Â  Â  Â  Â  Â  mySetDownloadLink(myRecordedVideoBlob, 'full_video_');
Â  Â  Â  Â  Â  Â  Â  Â  myRecordedVideo.src = URL.createObjectURL(myRecordedVideoBlob);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Fallback for when there's no recording/upload
Â  Â  Â  Â  Â  Â  Â  Â  myRecordedVideo.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  myDownloadLink.href = '#';
Â  Â  Â  Â  Â  Â  Â  Â  myDownloadLink.textContent = 'Download Video';
Â  Â  Â  Â  Â  Â  Â  Â  myDownloadLink.style.backgroundColor = '#6c757d';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function myTakePhoto() {
Â  Â  Â  Â  Â  Â  // Draw the current frame to the canvas
Â  Â  Â  Â  Â  Â  myCanvasContext.drawImage(myLiveStreamVideo, 0, 0, myVideoCanvas.width, myVideoCanvas.height);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Convert canvas to a Blob (image)
Â  Â  Â  Â  Â  Â  myVideoCanvas.toBlob(function(blob) {
Â  Â  Â  Â  Â  Â  Â  Â  const myURL = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Set up a temporary link for the image download
Â  Â  Â  Â  Â  Â  Â  Â  const myTempLink = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  myTempLink.href = myURL;
Â  Â  Â  Â  Â  Â  Â  Â  myTempLink.download = 'photo_' + Date.now() + '.png';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(myTempLink);
Â  Â  Â  Â  Â  Â  Â  Â  myTempLink.click();
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(myTempLink);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clean up the URL object
Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(myURL);
Â  Â  Â  Â  Â  Â  }, 'image/png');
Â  Â  Â  Â  }

        function myStartRecording() {
Â  Â  Â  Â  Â  Â  myRecordedChunks = [];
Â  Â  Â  Â  Â  Â  myIsRecording = true;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Get the current stream from the video element
Â  Â  Â  Â  Â  Â  const myStream = myLiveStreamVideo.srcObject;
Â  Â  Â  Â  Â  Â  const myMimeType = myFormatSelect.value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  myMediaRecorder = new MediaRecorder(myStream, { mimeType: myMimeType });
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("MediaRecorder failed to initialize:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Recording failed: The selected format may not be supported.");
Â  Â  Â  Â  Â  Â  Â  Â  myIsRecording = false;
Â  Â  Â  Â  Â  Â  Â  Â  myToggleRecording(); // Reset button state
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myMediaRecorder.ondataavailable = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.data.size > 0) myRecordedChunks.push(e.data);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  myMediaRecorder.onstop = myHandleRecordingStop;
Â  Â  Â  Â  Â  Â  myMediaRecorder.start(100); // Collect data in 100ms chunks
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myRecordButton.textContent = 'â¹ï¸ Stop Recording';
Â  Â  Â  Â  Â  Â  myRecordButton.style.backgroundColor = '#dc3545'; // Red
Â  Â  Â  Â  Â  Â  myPauseButton.disabled = false;
Â  Â  Â  Â  Â  Â  myPauseButton.textContent = 'â¸ï¸ Pause';
Â  Â  Â  Â  }

        function myStopRecording() {
Â  Â  Â  Â  Â  Â  myIsRecording = false;
Â  Â  Â  Â  Â  Â  if (myMediaRecorder && myMediaRecorder.state !== 'inactive') {
Â  Â  Â  Â  Â  Â  Â  Â  myMediaRecorder.stop();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  myRecordButton.textContent = 'ğŸ”´ Start Recording';
Â  Â  Â  Â  Â  Â  myRecordButton.style.backgroundColor = '#28a745'; // Green
Â  Â  Â  Â  Â  Â  myPauseButton.disabled = true;
Â  Â  Â  Â  }

        function myHandleRecordingStop() {
Â  Â  Â  Â  Â  Â  if (myRecordedChunks.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Recording was empty.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const myRecordedBlob = new Blob(myRecordedChunks, { type: myMediaRecorder.mimeType });
Â  Â  Â  Â  Â  Â  mySetDownloadLink(myRecordedBlob, 'recorded_video_');
Â  Â  Â  Â  Â  Â  mySetRecordedVideoForTrimming(myRecordedBlob);
Â  Â  Â  Â  Â  Â  myTrimmingControls.style.display = 'block';
Â  Â  Â  Â  }

        function myToggleRecording() {
Â  Â  Â  Â  Â  Â  if (myIsRecording) {
Â  Â  Â  Â  Â  Â  Â  Â  myStopRecording();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  myStartRecording();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        function myTogglePause() {
Â  Â  Â  Â  Â  Â  if (!myMediaRecorder) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (myMediaRecorder.state === 'recording') {
Â  Â  Â  Â  Â  Â  Â  Â  myMediaRecorder.pause();
Â  Â  Â  Â  Â  Â  Â  Â  myIsPaused = true;
Â  Â  Â  Â  Â  Â  Â  Â  myPauseButton.textContent = 'â–¶ï¸ Resume';
Â  Â  Â  Â  Â  Â  Â  Â  myPauseButton.style.backgroundColor = '#28a745';
Â  Â  Â  Â  Â  Â  } else if (myMediaRecorder.state === 'paused') {
Â  Â  Â  Â  Â  Â  Â  Â  myMediaRecorder.resume();
Â  Â  Â  Â  Â  Â  Â  Â  myIsPaused = false;
Â  Â  Â  Â  Â  Â  Â  Â  myPauseButton.textContent = 'â¸ï¸ Pause';
Â  Â  Â  Â  Â  Â  Â  Â  myPauseButton.style.backgroundColor = '#17a2b8';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Video Merging Functions ---

Â  Â  Â  Â  myVideoFile1.onchange = function(e) {
Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  myVideo1Blob = file;
Â  Â  Â  Â  Â  Â  Â  Â  myPreview1.src = URL.createObjectURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  myPreview1.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  myPreview1.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myVideo1Info.textContent = 'Duration: ' + myPreview1.duration.toFixed(1) + 's';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCheckMergeReady();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  myVideoFile2.onchange = function(e) {
Â  Â  Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  myVideo2Blob = file;
Â  Â  Â  Â  Â  Â  Â  Â  myPreview2.src = URL.createObjectURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  myPreview2.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  myPreview2.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myVideo2Info.textContent = 'Duration: ' + myPreview2.duration.toFixed(1) + 's';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCheckMergeReady();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  function myCheckMergeReady() {
Â  Â  Â  Â  Â  Â  if (myVideo1Blob && myVideo2Blob) {
Â  Â  Â  Â  Â  Â  Â  Â  myMergeButton.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  myMergeButton.onclick = async function() {
Â  Â  Â  Â  Â  Â  myMergeButton.disabled = true;
Â  Â  Â  Â  Â  Â  myMergeProgress.style.display = 'block';
Â  Â  Â  Â  Â  Â  myProgressBar.style.width = '0%';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const mergedBlob = await myMergeTwoVideos(myVideo1Blob, myVideo2Blob);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  myProgressBar.style.width = '100%';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  myMergedVideo.src = URL.createObjectURL(mergedBlob);
Â  Â  Â  Â  Â  Â  Â  Â  myMergedVideo.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  myMergedDownloadLink.href = myMergedVideo.src;
Â  Â  Â  Â  Â  Â  Â  Â  myMergedDownloadLink.download = 'merged_video_' + Date.now() + '.webm';
Â  Â  Â  Â  Â  Â  Â  Â  myMergedDownloadLink.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myMergeProgress.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myMergeButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error merging videos:', error);
Â  Â  Â  Â  Â  Â  Â  Â  myMergeProgress.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  myMergeButton.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  async function myMergeTwoVideos(blob1, blob2) {
Â  Â  Â  Â  Â  Â  return new Promise(function(resolve, reject) {
Â  Â  Â  Â  Â  Â  Â  Â  const video1 = document.createElement('video');
Â  Â  Â  Â  Â  Â  Â  Â  const video2 = document.createElement('video');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  video1.src = URL.createObjectURL(blob1);
Â  Â  Â  Â  Â  Â  Â  Â  video2.src = URL.createObjectURL(blob2);
Â  Â  Â  Â  Â  Â  Â  Â  video1.muted = false;
Â  Â  Â  Â  Â  Â  Â  Â  video2.muted = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let video1Ready = false;
Â  Â  Â  Â  Â  Â  Â  Â  let video2Ready = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  video1.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video1Ready = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (video2Ready) startMerge();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  video2.onloadedmetadata = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video2Ready = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (video1Ready) startMerge();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  function startMerge() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const width = Math.max(video1.videoWidth, video2.videoWidth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const height = Math.max(video1.videoHeight, video2.videoHeight);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const stream = canvas.captureStream(30);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const audioContext = new AudioContext();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const recorder = new MediaRecorder(stream, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mimeType: 'video/webm;codecs=vp8,opus',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audioBitsPerSecond: 128000,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoBitsPerSecond: 2500000
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const chunks = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.ondataavailable = function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.data.size > 0) chunks.push(e.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.onstop = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audioContext.close();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(new Blob(chunks, { type: 'video/webm' }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentVideo = video1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let isFirstVideo = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const source1 = audioContext.createMediaElementSource(video1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const source2 = audioContext.createMediaElementSource(video2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const destination = audioContext.createMediaStreamDestination();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  source1.connect(destination);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  source2.connect(destination);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const audioTrack = destination.stream.getAudioTracks()[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (audioTrack) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stream.addTrack(audioTrack);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video1.play();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myProgressBar.style.width = '20%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const drawFrame = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(currentVideo, 0, 0, width, height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentVideo.ended) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isFirstVideo) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFirstVideo = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentVideo = video2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video2.play();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myProgressBar.style.width = '60%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(drawFrame);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recorder.stop();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video1.pause();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  video2.pause();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(drawFrame);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawFrame();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 6. Initialization on Page Load & Event Listeners ---

Â  Â  Â  Â  myLoadResolutionPresets();
Â  Â  Â  Â  myLoadSupportedFormats();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Initial setup for the main download link (always visible, but initially disabled/grey)
Â  Â  Â  Â  myDownloadLink.textContent = 'Ready for action';
Â  Â  Â  Â  myDownloadLink.href = '#';
Â  Â  Â  Â  myDownloadLink.style.backgroundColor = '#6c757d';


Â  Â  Â  Â  // Event listeners
        // NEW: This triggers the camera setup and permission prompt
        myStartButton.addEventListener('click', myRequestMediaPermissionAndSetupCameras);

        // These events are ready to go once the camera is started and controls are visible
Â  Â  Â  Â  myCameraSelect.onchange = function() {
Â  Â  Â  Â  Â  Â  myChangeCamera(this.value);
Â  Â  Â  Â  };

Â  Â  Â  Â  myResolutionSelect.onchange = function() {
Â  Â  Â  Â  Â  Â  myChangeCamera(myCameraSelect.value);
Â  Â  Â  Â  };

Â  Â  Â  Â  myPhotoButton.onclick = myTakePhoto;
Â  Â  Â  Â  myRecordButton.onclick = myToggleRecording;
Â  Â  Â  Â  myPauseButton.onclick = myTogglePause;
        myCancelTrimButton.onclick = myCancelTrimming;

Â  Â  </script>
</body>
</html>
