<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Webcam Recorder with Trimming and Merging</title>
</head>
<body style="font-family: sans-serif; text-align: center; margin-top: 20px;">
Â  Â Â 
Â  Â  <h1 style="color: #007bff;">Webcam Capture and Recorder</h1>

Â  Â  <p>My main UnoQ Index <a href="https://hpssjellis.github.io/my-examples-UnoQ-qualcomm-edgeimpulse-arduino/public/index.html"> here </a> </p>Â Â 
Â  Â  <p>My UnoQ Github is<a href="https://github.com/hpssjellis/my-examples-UnoQ-qualcomm-edgeimpulse-arduino"> my-examples-of-UnoQ... </a> </p>Â Â 
Â  Â  <p>You can find more of my work on my <a href="https://github.com/hpssjellis"> hpssjellis </a> GitHub Profile page:</p>
Â  Â  <p>Follow me Jeremy Ellis on <a href="https://ca.linkedin.com/in/jeremy-ellis-4237a9bb"> LinkedIn </a><br></p>

Â  Â  <video id="myLiveStreamVideo" autoplay playsinline style="display: none;"></video>

Â  Â  <canvas id="myVideoCanvas" width="640" height="480" style="border: 2px solid #ccc; max-width: 90%; margin-bottom: 20px;"></canvas>

    <div id="myStartSection" style="margin-bottom: 20px;">
        <button id="myStartButton" style="padding: 15px 30px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.2em;">
            â–¶ï¸ Start Webcam and Enable Controls
        </button>
    </div>
    Â  Â  <div id="myControls" style="display: none; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select id="myCameraSelect" style="padding: 10px; border: 1px solid #007bff; border-radius: 5px;">
Â  Â  Â  Â  Â  Â  <option>Select Camera</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select id="myResolutionSelect" style="padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
Â  Â  Â  Â  Â  Â  <option>Loading Resolutions...</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <select id="myFormatSelect" style="padding: 10px; border: 1px solid #28a745; border-radius: 5px;" disabled>
Â  Â  Â  Â  Â  Â  <option>Loading Formats...</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="myPhotoButton" style="padding: 10px 20px; background-color: #ffc107; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  ğŸ“¸ Take Photo
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <button id="myRecordButton" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  ğŸ”´ Start Recording
Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  <button id="myPauseButton" style="padding: 10px 20px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  â¸ï¸ Pause
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <a id="myDownloadLink" style="display: inline-block; padding: 10px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 5px;">Download Video</a>
Â  Â  </div>
Â  Â Â 
Â  Â  <div style="margin-top: 20px; margin-bottom: 20px;">
Â  Â  Â  Â  <h3 style="margin: 0 0 10px 0;">Upload Video for Clipping/Trimming</h3>
Â  Â  Â  Â  <input type="file" id="myUploadClipFile" accept="video/*" style="padding: 10px; border: 1px solid #007bff; border-radius: 5px;">
Â  Â  </div>

    Â  Â  <video id="myRecordedVideo" controls style="display: none; border: 2px solid green; max-width: 90%; margin-bottom: 20px;"></video>

Â  Â  <div id="myTrimmingControls" style="display: none; max-width: 640px; margin: 0 auto 20px auto; padding: 15px; border: 2px solid #007bff; border-radius: 5px; background-color: #f0f8ff;">
Â  Â  Â  Â  <h3 style="margin-top: 0;">Trim Video</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">Start Time: <span id="myStartTimeDisplay">0.0s</span></label>
Â  Â  Â  Â  Â  Â  <input type="range" id="myStartSlider" min="0" max="100" value="0" step="0.1" style="width: 100%;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  <label style="display: block; margin-bottom: 5px; font-weight: bold;">End Time: <span id="myEndTimeDisplay">0.0s</span></label>
Â  Â  Â  Â  Â  Â  <input type="range" id="myEndSlider" min="0" max="100" value="100" step="0.1" style="width: 100%;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="margin-bottom: 10px;">
Â  Â  Â  Â  Â  Â  <strong>Duration:</strong> <span id="myDurationDisplay">0.0s</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="mySaveTrimmedButton" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px;">
Â  Â  Â  Â  Â  Â  ğŸ’¾ Prep for Download Trimmed Video
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="myCancelTrimButton" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
Â  Â  Â  Â  Â  Â  âŒ Cancel (Keep Full Video)
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div id="myMergingControls" style="max-width: 800px; margin: 0 auto 20px auto; padding: 15px; border: 2px solid #ff6b6b; border-radius: 5px; background-color: #fff5f5;">
Â  Â  Â  Â  <h3 style="margin-top: 0;">ğŸ¬ Merge Two Videos</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
Â  Â  Â  Â  Â  Â  <div style="flex: 1; min-width: 250px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Video 1 (First)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="myVideoFile1" accept="video/*" style="margin-bottom: 10px; display: block; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <video id="myPreview1" controls style="width: 100%; max-height: 200px; border: 2px solid #ddd; display: none;"></video>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="myVideo1Info" style="font-size: 12px; color: #666;"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div style="flex: 1; min-width: 250px;">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>Video 2 (Second)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="myVideoFile2" accept="video/*" style="margin-bottom: 10px; display: block; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <video id="myPreview2" controls style="width: 100%; max-height: 200px; border: 2px solid #ddd; display: none;"></video>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="myVideo2Info" style="font-size: 12px; color: #666;"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button id="myMergeButton" style="padding: 10px 20px; background-color: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;" disabled>
Â  Â  Â  Â  Â  Â  ğŸï¸ Merge Videos
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="myMergeProgress" style="display: none; margin-top: 15px;">
Â  Â  Â  Â  Â  Â  <p><strong>Processing...</strong></p>
Â  Â  Â  Â  Â  Â  <div style="width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="myProgressBar" style="width: 0%; background-color: #4CAF50; height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <video id="myMergedVideo" controls style="display: none; width: 100%; max-width: 640px; margin-top: 15px; border: 2px solid #4CAF50;"></video>
Â  Â  Â  Â  <a id="myMergedDownloadLink" style="display: none; padding: 10px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 5px; margin-top: 10px; inline-block;">Download Merged Video</a>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Global Variables (UPDATED to include myStartButton) ---
        const myStartButton = document.getElementById('myStartButton'); // NEW
        const myStartSection = document.getElementById('myStartSection'); // NEW
        const myControls = document.getElementById('myControls'); // Get the controls div

Â  Â  Â  Â  const myLiveStreamVideo = document.getElementById('myLiveStreamVideo');
Â  Â  Â  Â  const myVideoCanvas = document.getElementById('myVideoCanvas');
Â  Â  Â  Â  const myRecordedVideo = document.getElementById('myRecordedVideo');
Â  Â  Â  Â  const myCameraSelect = document.getElementById('myCameraSelect');
Â  Â  Â  Â  const myResolutionSelect = document.getElementById('myResolutionSelect');
Â  Â  Â  Â  const myFormatSelect = document.getElementById('myFormatSelect');
Â  Â  Â  Â  const myPhotoButton = document.getElementById('myPhotoButton');
Â  Â  Â  Â  const myRecordButton = document.getElementById('myRecordButton');
Â  Â  Â  Â  const myPauseButton = document.getElementById('myPauseButton');
Â  Â  Â  Â  const myDownloadLink = document.getElementById('myDownloadLink');
Â  Â  Â  Â  const myCanvasContext = myVideoCanvas.getContext('2d');

Â  Â  Â  Â  // NEW: Upload button for clipping
Â  Â  Â  Â  const myUploadClipFile = document.getElementById('myUploadClipFile');Â 

Â  Â  Â  Â  // Trimming elements
Â  Â  Â  Â  const myTrimmingControls = document.getElementById('myTrimmingControls');
Â  Â  Â  Â  const myStartSlider = document.getElementById('myStartSlider');
Â  Â  Â  Â  const myEndSlider = document.getElementById('myEndSlider');
Â  Â  Â  Â  const myStartTimeDisplay = document.getElementById('myStartTimeDisplay');
Â  Â  Â  Â  const myEndTimeDisplay = document.getElementById('myEndTimeDisplay');
Â  Â  Â  Â  const myDurationDisplay = document.getElementById('myDurationDisplay');
Â  Â  Â  Â  const mySaveTrimmedButton = document.getElementById('mySaveTrimmedButton');
Â  Â  Â  Â  const myCancelTrimButton = document.getElementById('myCancelTrimButton');

Â  Â  Â  Â  // Merging elements (omitted for brevity, assume they are included)
        const myVideoFile1 = document.getElementById('myVideoFile1');
Â  Â  Â  Â  const myVideoFile2 = document.getElementById('myVideoFile2');
Â  Â  Â  Â  const myPreview1 = document.getElementById('myPreview1');
Â  Â  Â  Â  const myPreview2 = document.getElementById('myPreview2');
Â  Â  Â  Â  const myVideo1Info = document.getElementById('myVideo1Info');
Â  Â  Â  Â  const myVideo2Info = document.getElementById('myVideo2Info');
Â  Â  Â  Â  const myMergeButton = document.getElementById('myMergeButton');
Â  Â  Â  Â  const myMergeProgress = document.getElementById('myMergeProgress');
Â  Â  Â  Â  const myProgressBar = document.getElementById('myProgressBar');
Â  Â  Â  Â  const myMergedVideo = document.getElementById('myMergedVideo');
Â  Â  Â  Â  const myMergedDownloadLink = document.getElementById('myMergedDownloadLink');


Â  Â  Â  Â  let myCurrentStream = null;
Â  Â  Â  Â  let myMediaRecorder = null;
Â  Â  Â  Â  let myRecordedChunks = [];
Â  Â  Â  Â  let myIsRecording = false;
Â  Â  Â  Â  let myRecordedVideoBlob = null; 
Â  Â  Â  Â  let myVideoDuration = 0;
Â  Â  Â  Â  let myVideo1Blob = null;
Â  Â  Â  Â  let myVideo2Blob = null;Â  

Â  Â  Â  Â  // --- Setup Functions (Mostly Unchanged) ---

Â  Â  Â  Â  function myLoadResolutionPresets() {
Â  Â  Â  Â  Â  Â  const myResolutionPresets = [
Â  Â  Â  Â  Â  Â  Â  Â  { width: 1280, height: 720, name: 'HD (720p)' },
Â  Â  Â  Â  Â  Â  Â  Â  { width: 640, height: 480, name: 'VGA (480p)' },
Â  Â  Â  Â  Â  Â  Â  Â  { width: 320, height: 240, name: 'QVGA (240p)' },
Â  Â  Â  Â  Â  Â  Â  Â  { width: 1920, height: 1080, name: 'Full HD (1080p)' }
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  myResolutionSelect.innerHTML = '';
Â  Â  Â  Â  Â  Â  for (const preset of myResolutionPresets) {
Â  Â  Â  Â  Â  Â  Â  Â  const myOption = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  myOption.value = preset.width + 'x' + preset.height;
Â  Â  Â  Â  Â  Â  Â  Â  myOption.textContent = preset.name;
Â  Â  Â  Â  Â  Â  Â  Â  myResolutionSelect.appendChild(myOption);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  myResolutionSelect.value = '640x480';Â Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function myLoadSupportedFormats() {
Â  Â  Â  Â  Â  Â  const myFormatsToCheck = [
Â  Â  Â  Â  Â  Â  Â  Â  { mime: 'video/webm; codecs=vp9,opus', name: 'WebM (High Quality)' },
Â  Â  Â  Â  Â  Â  Â  Â  { mime: 'video/webm; codecs=vp8,opus', name: 'WebM (Standard)' },
Â  Â  Â  Â  Â  Â  Â  Â  { mime: 'video/webm', name: 'WebM (Default)' }
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  myFormatSelect.innerHTML = '';
Â  Â  Â  Â  Â  Â  let mySupportedCount = 0;

Â  Â  Â  Â  Â  Â  for (const format of myFormatsToCheck) {
Â  Â  Â  Â  Â  Â  Â  Â  if (MediaRecorder.isTypeSupported(format.mime)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const myOption = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myOption.value = format.mime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myOption.textContent = format.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myFormatSelect.appendChild(myOption);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mySupportedCount++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (mySupportedCount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  myFormatSelect.disabled = false;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  myFormatSelect.innerHTML = '<option>No Recording Formats Supported</option>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // RENAMED/MODIFIED: This function now requests permission and populates the select box
Â  Â  Â  Â  async function myRequestMediaPermissionAndSetupCameras() {
            // Disable button and show loading state
            myStartButton.disabled = true;
            myStartButton.textContent = 'â³ Loading Cameras...';
            myCameraSelect.innerHTML = '<option>Searching...</option>';
            
            // Step 1: Request permission (this triggers the browser prompt)
Â  Â  Â  Â  Â  Â  try {
                // Request a temporary stream to trigger permission and enable device enumeration
Â  Â  Â  Â  Â  Â  Â  Â  const myTempStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
Â  Â  Â  Â  Â  Â  Â  Â  myTempStream.getTracks().forEach(track => track.stop()); // Stop the temp stream immediately
Â  Â  Â  Â  Â  Â  Â  Â Â 
                // Step 2: Enumerate devices now that permission is granted
Â  Â  Â  Â  Â  Â  Â  Â  const myDevices = await navigator.mediaDevices.enumerateDevices();
Â  Â  Â  Â  Â  Â  Â  Â  myCameraSelect.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  let myCameraCount = 0;
                let defaultDeviceId = null;

Â  Â  Â  Â  Â  Â  Â  Â  for (const myDevice of myDevices) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (myDevice.kind === 'videoinput') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const myOption = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myOption.value = myDevice.deviceId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myOption.textContent = myDevice.label || 'Camera ' + (++myCameraCount);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCameraSelect.appendChild(myOption);
                        if (!defaultDeviceId) defaultDeviceId = myDevice.deviceId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCameraCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

                // Step 3: Start streaming the default camera and show controls
Â  Â  Â  Â  Â  Â  Â  Â  if (defaultDeviceId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myChangeCamera(defaultDeviceId); // Start the stream
                    myStartSection.style.display = 'none';
                    myControls.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  myCameraSelect.innerHTML = '<option>No Cameras Found</option>';
                    myStartButton.textContent = 'âŒ No Cameras Found';
                    myStartButton.style.backgroundColor = '#dc3545';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error enumerating devices or permission denied:", error);
Â  Â  Â  Â  Â  Â  Â  Â  myCameraSelect.innerHTML = '<option>Permission Denied</option>';
                myStartButton.textContent = 'ğŸ›‘ Permission Denied. Click to try again.';
                myStartButton.style.backgroundColor = '#ffc107';
                myStartButton.disabled = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // (The rest of the JS functions, like myChangeCamera, myDrawLoop, myTogglePause, etc., are unchanged)

        // The remaining functions (myStopCurrentStream, myChangeCamera, myDrawLoop, myTogglePause, myTakePhoto, myToggleRecording, myStartRecording, myStopRecording, myHandleRecordingStop, mySetDownloadLink, mySetRecordedVideoForTrimming, myUploadClipFile.onchange, mySetupTrimmingControls, myUpdateTrimmingDisplay, myTrimAndSaveVideo, myTrimVideoWithAudio, myCancelTrimming, myUpdateVideoInfo, myLoadFFmpeg, myVideoFile1.onchange, myVideoFile2.onchange, myCheckMergeReady, myMergeButton.onclick, myMergeTwoVideos) are assumed to be in the code block and remain functional.

        // --- Initial Setup and New Event Listener ---

        // 1. Load static elements (resolutions, formats) on page load.
Â  Â  Â  Â  myLoadResolutionPresets();
Â  Â  Â  Â  myLoadSupportedFormats();
        
        // 2. DO NOT CALL myGetCameras() on load!

        // 3. Set up the new Start Button listener
        myStartButton.addEventListener('click', myRequestMediaPermissionAndSetupCameras);

        // 4. Set up existing event listeners for controls (after they become visible)
        myCameraSelect.addEventListener('change', (e) => myChangeCamera(e.target.value));
Â  Â  Â  Â  myResolutionSelect.addEventListener('change', (e) => myChangeCamera(myCameraSelect.value));
Â  Â  Â  Â  myPhotoButton.addEventListener('click', myTakePhoto);
Â  Â  Â  Â  myRecordButton.addEventListener('click', myToggleRecording);
Â  Â  Â  Â  myPauseButton.addEventListener('click', myTogglePause);

        // Optional: Pre-load FFmpeg in the background
        // myLoadFFmpeg().catch(err => console.log("FFmpeg failed to pre-load:", err));

Â  Â  </script>
</body>
</html>
